<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android" 
      xmlns:tools="http://schemas.android.com/tools">

  <init>
    <setStringFromProperty 
      result="PackageName"
      ini="Engine"
      section="/Script/AndroidRuntimeSettings.AndroidRuntimeSettings" 
      property="PackageName" 
      default="" />

    <setStringFromProperty 
      result="FacebookAppID" 
      ini="Engine" 
      section="/Script/FirebaseAuthenticationEditor.FirebaseSettings" 
      property="FacebookAppID" 
      default="" />
  </init>

  <!-- Add Facebook dependencies -->
  <androidManifestUpdates>
    <addElements tag="application">
      <meta-data
        android:name="com.facebook.sdk.ApplicationId"
        android:value="@string/FacebookAppID"
        tools:replace="android:value" />

      <activity
        android:name="com.facebook.FacebookActivity"
        android:configChanges="keyboard|keyboardHidden|screenLayout|screenSize|orientation"
        android:label="@string/app_name"
        android:theme="@android:style/Theme.Translucent.NoTitleBar"
        tools:replace="android:theme" />
    </addElements>
    <addPermission android:name="android.permission.INTERNET" />
  </androidManifestUpdates>

  <gradleProperties>
    <insertValue value="FACEBOOK_APP_ID=$S(FacebookAppID)" />
    <insertNewline/>
  </gradleProperties>
  
  <buildGradleAdditions>
    <insert>
      apply plugin: 'com.google.gms.google-services'
      android 
      {
          buildTypes 
          {
              buildTypes.each
              {
                  it.signingConfig signingConfigs.release
                  it.resValue "string", "FacebookAppID", FACEBOOK_APP_ID
              }
          }
      }
    </insert>
  </buildGradleAdditions>

  <!-- Copy Library directory & google-services.json -->
  <gradleCopies>
    <copyDir
      src="$S(PluginDir)/ThirdParty/Android/FirebaseAuthentication/"
      dst="$S(BuildDir)/gradle/app/src/main/java/com/thegetaway/firebaseauthentication/"/>
    
    <copyFile
      src="$S(PluginDir)/../../../../Build/Android/google-services.json"
      dst="$S(BuildDir)/gradle/app/google-services.json"/>
  </gradleCopies>

  <!-- Import dependencies -->
  <AARImports>
    <insertValue value="com.google.firebase,firebase-core,16.0.9" />
    <insertNewline/>

    <insertValue value="com.google.firebase,firebase-auth,16.2.1" />
    <insertNewline/>

    <insertValue value="com.facebook.android,facebook-login,4.42.0" />
    <insertNewline/>

    <replace find="play-services-auth,11.8.0"   with="play-services-auth,16.0.0"/>
    <replace find="play-services-games,11.8.0"  with="play-services-games,16.0.0"/>
    <replace find="play-services-nearby,11.8.0" with="play-services-nearby,16.0.0"/>
    <replace find="play-services-plus,11.8.0"   with="play-services-plus,16.0.0"/>
  </AARImports>

  <buildscriptGradleAdditions>
    <insert>
      dependencies
      {
          classpath 'com.google.gms:google-services:4.0.0'
      }
    </insert>
  </buildscriptGradleAdditions>

  <!-- GameActivity.java additions -->
  <gameActivityImportAdditions>
    <insert>
      import com.thegetaway.firebaseauthentication.EmailPasswordAuthentication;
      import com.thegetaway.firebaseauthentication.AnonymousAuthentication;
      import com.thegetaway.firebaseauthentication.FacebookAuthentication;
      import com.thegetaway.firebaseauthentication.GoogleAuthentication;
      import com.thegetaway.firebaseauthentication.OAuthAuthentication;
      import com.thegetaway.firebaseauthentication.PhoneAuthentication;
      import com.thegetaway.firebaseauthentication.BaseAuthentication;
    </insert>
  </gameActivityImportAdditions>

  <gameActivityOnCreateAdditions>
    <insert>
      // Initialize classes
      EmailPasswordAuth = new EmailPasswordAuthentication();
      AnonymousAuth = new AnonymousAuthentication();
      FacebookAuth = new FacebookAuthentication(this);
      GoogleAuth = new GoogleAuthentication(this);
      PhoneAuth = new PhoneAuthentication(this);
      OAuth = new OAuthAuthentication(this);
    </insert>
  </gameActivityOnCreateAdditions>
  
  <gameActivityClassAdditions>
    <insert>
      private EmailPasswordAuthentication EmailPasswordAuth;
      private AnonymousAuthentication AnonymousAuth;
      private FacebookAuthentication FacebookAuth;
      private GoogleAuthentication GoogleAuth;
      private PhoneAuthentication PhoneAuth;
      private OAuthAuthentication OAuth;

      // Email/Password Authentication methods
      public void AndroidThunkJava_EmailPasswordSignIn(String Email, String Password) { EmailPasswordAuth.EmailPasswordSignIn(Email, Password); }
      public void AndroidThunkJava_CreateAccount(String Email, String Password) { EmailPasswordAuth.CreateAccount(Email, Password); }
      public void AndroidThunkJava_SendEmailVerification() { EmailPasswordAuth.SendEmailVerification(); }

      // PhoneAuthentication Authentication methods
      public void AndroidThunkJava_StartPhoneNumberVerification(String PhoneNumber, int Timeout) { PhoneAuth.StartPhoneNumberVerification(PhoneNumber, Timeout); }
      public void AndroidThunkJava_ResendVerificationCode(String PhoneNumber, int Timeout) { PhoneAuth.ResendVerificationCode(PhoneNumber, Timeout); }
      public void AndroidThunkJava_VerifyPhoneNumberWithCode(String Code) { PhoneAuth.VerifyPhoneNumberWithCode(Code); }

      // Google Authentication methods
      public void AndroidThunkJava_GoogleSignIn() { GoogleAuth.GoogleSignIn(); }
      public void AndroidThunkJava_GoogleSignOut() { GoogleAuth.GoogleSignOut(); }
      public void AndroidThunkJava_GoogleRevokeAccess() { GoogleAuth.GoogleRevokeAccess(); }

      // Anonymous Authentication methods
      public void AndroidThunkJava_AnonymousSignIn() { AnonymousAuth.AnonymousSignIn(); }
      public void AndroidThunkJava_AnonymousLinkAccount(String Email, String Password) { AnonymousAuth.AnonymousLinkAccount(Email, Password); }

      // Facebook Authentication methods
      public void AndroidThunkJava_FacebookSignIn() { FacebookAuth.FacebookSignIn(); }
      public void AndroidThunkJava_FacebookSignOut() { FacebookAuth.FacebookSignOut(); }

      // OAuth Authentication methods
      public void AndroidThunkJava_OAuthSignIn(String ProviderID) { OAuth.OAuthSignIn(ProviderID); }

      // Firebase methods
      public void AndroidThunkJava_FirebaseSignOut() { BaseAuthentication.FirebaseAccountSignOut(); }
    </insert>
  </gameActivityClassAdditions>

  <gameActivityOnActivityResultAdditions>
    <insert>
      GoogleAuth.ActivityResult(requestCode, data);
      FacebookAuth.ActivityResult(requestCode, resultCode, data);
    </insert>
  </gameActivityOnActivityResultAdditions>
  
</root>